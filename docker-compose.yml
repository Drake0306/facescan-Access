version: '3.8'

services:
  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    container_name: facescan-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${DB_NAME:-facescan_db}
      POSTGRES_USER: ${DB_USER:-facescan_user}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-changeme}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=en_US.UTF-8"
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backend/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - facescan-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-facescan_user}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # pgAdmin - Database Management UI
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: facescan-pgadmin
    restart: unless-stopped
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@example.com}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:-admin}
      PGADMIN_CONFIG_SERVER_MODE: 'False'
      PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED: 'False'
    ports:
      - "5050:80"
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    networks:
      - facescan-network
    depends_on:
      - postgres

  # Backend API Service
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: facescan-backend
    restart: unless-stopped
    environment:
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: ${DB_NAME:-facescan_db}
      DB_USER: ${DB_USER:-facescan_user}
      DB_PASSWORD: ${DB_PASSWORD:-changeme}
      API_SECRET_KEY: ${API_SECRET_KEY:-dev-secret-key-change-in-production}
      API_ALGORITHM: ${API_ALGORITHM:-HS256}
      ACCESS_TOKEN_EXPIRE_MINUTES: ${ACCESS_TOKEN_EXPIRE_MINUTES:-1440}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    ports:
      - "8000:8000"
    volumes:
      - ./backend:/app
      - backend_data:/data
    networks:
      - facescan-network
    depends_on:
      postgres:
        condition: service_healthy
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload

  # Face Recognition Service
  face-service:
    build:
      context: ./face-service
      dockerfile: Dockerfile
    container_name: facescan-face-service
    restart: unless-stopped
    environment:
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: ${DB_NAME:-facescan_db}
      DB_USER: ${DB_USER:-facescan_user}
      DB_PASSWORD: ${DB_PASSWORD:-changeme}
      FACE_RECOGNITION_THRESHOLD: ${FACE_RECOGNITION_THRESHOLD:-0.6}
      FACE_DETECTION_MODEL: ${FACE_DETECTION_MODEL:-hog}
      ENTRY_CAMERA_TYPE: ${ENTRY_CAMERA_TYPE:-webcam}
      ENTRY_CAMERA_RTSP: ${ENTRY_CAMERA_RTSP:-}
      ENTRY_CAMERA_INDEX: ${ENTRY_CAMERA_INDEX:-0}
      EXIT_CAMERA_TYPE: ${EXIT_CAMERA_TYPE:-webcam}
      EXIT_CAMERA_RTSP: ${EXIT_CAMERA_RTSP:-}
      EXIT_CAMERA_INDEX: ${EXIT_CAMERA_INDEX:-1}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    ports:
      - "8001:8001"
    volumes:
      - ./face-service:/app
      - face_data:/data
      - /dev/video0:/dev/video0  # Webcam access (Linux)
    networks:
      - facescan-network
    depends_on:
      postgres:
        condition: service_healthy
    privileged: true  # Required for camera access
    command: uvicorn app.main:app --host 0.0.0.0 --port 8001 --reload

  # Gate Controller Service
  gate-controller:
    build:
      context: ./gate-controller
      dockerfile: Dockerfile
    container_name: facescan-gate-controller
    restart: unless-stopped
    environment:
      GATE_CONTROLLER_TYPE: ${GATE_CONTROLLER_TYPE:-mock}
      GATE_CONTROLLER_HOST: ${GATE_CONTROLLER_HOST:-192.168.1.50}
      GATE_CONTROLLER_PORT: ${GATE_CONTROLLER_PORT:-80}
      GATE_OPEN_DURATION: ${GATE_OPEN_DURATION:-5}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    ports:
      - "8002:8002"
    volumes:
      - ./gate-controller:/app
    networks:
      - facescan-network
    devices:
      - /dev/ttyUSB0:/dev/ttyUSB0  # Serial port access (if using serial relay)
    privileged: true  # Required for hardware access
    command: uvicorn app.main:app --host 0.0.0.0 --port 8002 --reload

networks:
  facescan-network:
    driver: bridge

volumes:
  postgres_data:
    driver: local
  pgadmin_data:
    driver: local
  backend_data:
    driver: local
  face_data:
    driver: local
